<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Browser & Bot Detection Telemetry</title>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --card-color: #16213e;
            --text-color: #e0e0e0;
            --primary-color: #0f3460;
            --accent-color: #e94560;
            --success-color: #5cb85c;
            --fail-color: #d9534f;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            margin: 0;
            padding: 2em;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            background-color: var(--card-color);
            border-radius: 12px;
            padding: 2em;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        h1, h2 {
            color: var(--accent-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5em;
            margin-top: 0;
        }

        h2 {
            margin-top: 1.5em;
        }

        .telemetry-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1em;
            margin-bottom: 1.5em;
        }

        .telemetry-item {
            background-color: var(--primary-color);
            padding: 1em;
            border-radius: 8px;
            overflow: hidden;
        }

        .telemetry-item strong {
            display: block;
            color: var(--accent-color);
            margin-bottom: 0.5em;
            font-size: 0.9em;
            text-transform: uppercase;
        }
        
        .telemetry-item span {
            word-wrap: break-word;
            font-size: 0.9em;
        }
        
        .bot-check-item {
            padding: 0.75em;
            border-left: 4px solid;
            margin-bottom: 0.5em;
        }

        .bot-check-item.pass {
            border-color: var(--success-color);
            background-color: rgba(92, 184, 92, 0.1);
        }
        
        .bot-check-item.fail {
            border-color: var(--fail-color);
            background-color: rgba(217, 83, 79, 0.1);
        }

        #final-decision {
            font-size: 1.2em;
            font-weight: bold;
            padding: 1em;
            text-align: center;
            border-radius: 8px;
            margin-top: 1em;
        }

        #captcha-challenge {
            display: none; /* Hidden by default */
            margin-top: 2em;
            padding: 1.5em;
            background-color: var(--primary-color);
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            text-align: center;
        }

        #captcha-challenge label {
            font-size: 1.1em;
            margin-right: 1em;
        }

        #captcha-challenge input {
            padding: 0.5em;
            border-radius: 4px;
            border: 1px solid var(--text-color);
            background: var(--bg-color);
            color: var(--text-color);
            width: 50px;
            text-align: center;
        }

        #captcha-challenge button {
            padding: 0.6em 1.2em;
            border: none;
            border-radius: 4px;
            background-color: var(--accent-color);
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-left: 1em;
            transition: background-color 0.2s ease;
        }

        #captcha-challenge button:hover {
            background-color: #ff6384;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>Advanced Browser Telemetry & Bot Detector ðŸ¤–</h1>

        <h2>Client Information</h2>
        <div class="telemetry-grid">
            <div class="telemetry-item"><strong>User Agent</strong><span id="user-agent"></span></div>
            <div class="telemetry-item"><strong>Device Type</strong><span id="device-type"></span></div>
            <div class="telemetry-item"><strong>Browser Language</strong><span id="language"></span></div>
            <div class="telemetry-item"><strong>Platform</strong><span id="platform"></span></div>
            <div class="telemetry-item"><strong>Screen Resolution</strong><span id="screen-res"></span></div>
            <div class="telemetry-item"><strong>CPU Cores</strong><span id="cpu-cores"></span></div>
            <div class="telemetry-item"><strong>Device Memory (GB)</strong><span id="device-memory"></span></div>
            <div class="telemetry-item"><strong>Timezone</strong><span id="timezone"></span></div>
            <div class="telemetry-item"><strong>Connection</strong><span id="connection"></span></div>
            <div class="telemetry-item"><strong>WebGL Renderer</strong><span id="webgl-renderer"></span></div>
            <div class="telemetry-item"><strong>Audio Fingerprint</strong><span id="audio-fp"></span></div>
            <div class="telemetry-item"><strong>Installed Fonts</strong><span id="fonts"></span></div>
            <div class="telemetry-item" style="grid-column: 1 / -1;"><strong>Canvas Fingerprint</strong><span id="canvas-fp"></span></div>
        </div>
        
        <h2>Server-Observed Headers</h2>
        <div class="telemetry-grid" id="server-headers-grid">
            </div>

        <h2>Bot Detection Analysis</h2>
        <div id="bot-detection-results">
            </div>
        <div id="final-decision"></div>

        <div id="captcha-challenge">
            <h3>Extra Verification Required</h3>
            <p>To continue, please solve this simple problem.</p>
            <div>
                <label for="captcha-input">What is 7 + 5?</label>
                <input type="number" id="captcha-input">
                <button id="captcha-verify-btn">Verify</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- CONFIGURATION ---
            const BOT_SCORE_THRESHOLD = 2; 
            const POW_DIFFICULTY = 6;
            
            // --- DOM ELEMENTS ---
            const telemetryElements = {
                userAgent: document.getElementById('user-agent'),
                language: document.getElementById('language'),
                platform: document.getElementById('platform'),
                deviceType: document.getElementById('device-type'),
                screenRes: document.getElementById('screen-res'),
                cpuCores: document.getElementById('cpu-cores'),
                deviceMemory: document.getElementById('device-memory'),
                timezone: document.getElementById('timezone'),
                connection: document.getElementById('connection'),
                webglRenderer: document.getElementById('webgl-renderer'),
                audioFp: document.getElementById('audio-fp'),
                fonts: document.getElementById('fonts'),
                canvasFp: document.getElementById('canvas-fp')
            };
            const botDetectionResultsDiv = document.getElementById('bot-detection-results');
            const finalDecisionDiv = document.getElementById('final-decision');
            const captchaChallengeDiv = document.getElementById('captcha-challenge');
            const captchaVerifyBtn = document.getElementById('captcha-verify-btn');
            const captchaInput = document.getElementById('captcha-input');
            
            // --- DATA COLLECTION FUNCTIONS ---
            
            function getCanvasFingerprint() {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const txt = 'Browser-Fingerprint-1.6.1-<3';
                    ctx.textBaseline = 'top';
                    ctx.font = "14px 'Arial'";
                    ctx.textBaseline = 'alphabetic';
                    ctx.fillStyle = '#f60';
                    ctx.fillRect(125, 1, 62, 20);
                    ctx.fillStyle = '#069';
                    ctx.fillText(txt, 2, 15);
                    ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                    ctx.fillText(txt, 4, 17);
                    return canvas.toDataURL().slice(0, 100) + '...';
                } catch (e) {
                    return 'Error';
                }
            }
            
            function getWebGLFingerprint() {
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    if (!gl) return 'No WebGL Support';
                    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    return gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
                } catch (e) {
                    return 'Error';
                }
            }

            async function getAudioFingerprint() {
                try {
                    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    const sampleRate = audioCtx.sampleRate;
                    await audioCtx.close();
                    return `Supported (Sample Rate: ${sampleRate})`;
                } catch (e) {
                    return 'No AudioContext Support';
                }
            }

            function getInstalledFonts() {
                const commonFonts = ['Arial', 'Verdana', 'Helvetica', 'Times New Roman', 'Courier New', 'Georgia', 'Comic Sans MS'];
                let detectedCount = 0;
                const baseElement = document.createElement('span');
                baseElement.style.fontSize = '72px';
                baseElement.innerHTML = 'a';
                const testElement = document.createElement('span');
                testElement.style.fontSize = '72px';
                testElement.innerHTML = 'a';
                
                document.body.appendChild(baseElement);
                document.body.appendChild(testElement);
                baseElement.style.fontFamily = 'monospace';
                
                commonFonts.forEach(font => {
                    testElement.style.fontFamily = `'${font}',monospace`;
                    if (baseElement.offsetWidth !== testElement.offsetWidth || baseElement.offsetHeight !== testElement.offsetHeight) {
                        detectedCount++;
                    }
                });
                
                document.body.removeChild(baseElement);
                document.body.removeChild(testElement);
                return `${detectedCount} of ${commonFonts.length} common fonts detected`;
            }

            function getConnectionInfo() {
                const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                if (!conn) return 'N/A';
                return `Type: ${conn.effectiveType}, Save Data: ${conn.saveData}`;
            }

            // --- 1. TELEMETRY COLLECTION ---
            async function collectTelemetry() {
                telemetryElements.userAgent.textContent = navigator.userAgent;
                telemetryElements.language.textContent = navigator.language || navigator.userLanguage;
                telemetryElements.platform.textContent = navigator.platform;
                telemetryElements.deviceType.textContent = /Mobi|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop';
                telemetryElements.screenRes.textContent = `${screen.width}x${screen.height}`;
                telemetryElements.cpuCores.textContent = navigator.hardwareConcurrency || 'N/A';
                telemetryElements.deviceMemory.textContent = navigator.deviceMemory ? `${navigator.deviceMemory} GB` : 'N/A';
                telemetryElements.timezone.textContent = Intl.DateTimeFormat().resolvedOptions().timeZone;
                telemetryElements.connection.textContent = getConnectionInfo();
                telemetryElements.webglRenderer.textContent = getWebGLFingerprint();
                telemetryElements.audioFp.textContent = await getAudioFingerprint();
                telemetryElements.fonts.textContent = getInstalledFonts();
                telemetryElements.canvasFp.textContent = getCanvasFingerprint();
            }

            // --- 2. SERVER HEADER COLLECTION ---
            async function fetchAndDisplayHeaders() {
                const grid = document.getElementById('server-headers-grid');
                try {
                    const response = await fetch('/api/headers');
                    if (!response.ok) throw new Error('Network response was not ok');
                    
                    const headers = await response.json();
                    
                    for (const key in headers) {
                        if (headers[key]) {
                            const item = document.createElement('div');
                            item.className = 'telemetry-item';
                            item.innerHTML = `<strong>${key.toUpperCase()}</strong><span>${headers[key]}</span>`;
                            grid.appendChild(item);
                        }
                    }
                } catch (error) {
                    console.error("Failed to fetch server headers:", error);
                    grid.innerHTML = '<p>Could not load server-side headers. Check browser console and Nginx config.</p>';
                }
            }

            // --- 3. BOT DETECTION CHECKS ---
            async function runBotDetection() {
                let botScore = 0;
                const results = [];

                if (navigator.webdriver) {
                    botScore += 3;
                    results.push({ check: 'Headless Browser Flag', passed: false, score: 2 });
                } else {
                    results.push({ check: 'Headless Browser Flag', passed: true, score: 0 });
                }
                
                if (navigator.plugins.length === 0) {
                    botScore++;
                    results.push({ check: 'Plugin Count', passed: false, note: 'Zero plugins found', score: 1 });
                } else {
                    results.push({ check: 'Plugin Count', passed: true, score: 0 });
                }
                
                if (getWebGLFingerprint().includes('No WebGL') || getWebGLFingerprint().includes('Error')) {
                    botScore += 2;
                    results.push({ check: 'WebGL Support', passed: false, score: 2 });
                } else {
                     results.push({ check: 'WebGL Support', passed: true, score: 0 });
                }

                if (getCanvasFingerprint() === 'Error') {
                    botScore += 2;
                    results.push({ check: 'Canvas Rendering', passed: false, note: 'Could not generate fingerprint', score: 2 });
                } else {
                     results.push({ check: 'Canvas Rendering', passed: true, score: 0 });
                }

                const powResult = await performProofOfWork(POW_DIFFICULTY);
                if (!powResult.success) {
                    botScore += 3;
                    results.push({ check: 'Proof-of-Work Challenge', passed: false, note: `Failed. Reason: ${powResult.time}`, score: 3 });
                } else {
                    results.push({ check: 'Proof-of-Work Challenge', passed: true, note: `Success. Time: ${powResult.time}ms`, score: 0 });
                }
                
                displayBotResults(results, botScore);
                
                if (botScore >= BOT_SCORE_THRESHOLD) {
                    finalDecisionDiv.textContent = `ðŸš¨ Bot Score: ${botScore}. Client flagged as a possible Bot.`;
                    finalDecisionDiv.style.backgroundColor = 'var(--fail-color)';
                    showCaptcha();
                } else {
                    finalDecisionDiv.textContent = `âœ… Bot Score: ${botScore}. Client appears to be a Human.`;
                    finalDecisionDiv.style.backgroundColor = 'var(--success-color)';
                }
            }

            // --- 4. PROOF OF WORK (PoW) ---
            async function performProofOfWork(difficulty) {
                if (!window.crypto || !window.crypto.subtle) {
                    console.warn('Proof of Work check skipped: Not a secure context (HTTPS is required).');
                    return { success: false, time: 'Insecure Context' };
                }

                const challenge = 'prove_you_are_human_' + Date.now();
                const target = '0'.repeat(difficulty);
                let nonce = 0;
                const startTime = performance.now();

                async function sha256(str) {
                    const buffer = new TextEncoder().encode(str);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                }

                while (true) {
                    if (performance.now() - startTime > 5000) return { success: false, time: 'Timeout' };
                    const hash = await sha256(challenge + nonce);
                    if (hash.startsWith(target)) {
                        return { success: true, time: (performance.now() - startTime).toFixed(2) };
                    }
                    nonce++;
                }
            }
            
            // --- 5. UI/DISPLAY LOGIC ---
            function displayBotResults(results, finalScore) {
                botDetectionResultsDiv.innerHTML = '';
                results.forEach(res => {
                    const item = document.createElement('div');
                    item.className = `bot-check-item ${res.passed ? 'pass' : 'fail'}`;
                    let text = `<strong>${res.check}:</strong> ${res.passed ? 'PASSED' : 'FAILED'}`;
                    if (res.note) text += ` (${res.note})`;
                    if (!res.passed) text += ` [+${res.score} to score]`;
                    item.innerHTML = text;
                    botDetectionResultsDiv.appendChild(item);
});
            }

            function showCaptcha() {
                captchaChallengeDiv.style.display = 'block';
            }

            // --- 6. CAPTCHA VERIFICATION ---
            captchaVerifyBtn.addEventListener('click', () => {
                if (parseInt(captchaInput.value, 10) === 12) {
                    alert('Verification successful! Thank you.');
                    captchaChallengeDiv.innerHTML = '<p>âœ… Verification Passed</p>';
                } else {
                    alert('Incorrect answer. Please try again.');
                    captchaInput.value = '';
                }
            });

            // --- 7. INITIALIZATION ---
            async function initialize() {
                await collectTelemetry();
                await fetchAndDisplayHeaders();
                await runBotDetection();
            }

            initialize();
        });
    </script>
</body>
</html>